@using SegundoCerebro.BlazorWasm.Models
@using SegundoCerebro.BlazorWasm.Models.Enums
@using SegundoCerebro.BlazorWasm.Services
@inject IAccountService AccountService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudForm Model="@model" @ref="@form">
            <MudCardContent>
                <MudTextField @bind-Value="model.Name" 
                              For="@(() => model.Name)" 
                              Immediately="true" 
                              Label="Account Name"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />

                <MudTextField @bind-Value="model.Description" 
                              For="@(() => model.Description)" 
                              Label="Description (Optional)"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Lines="2" />

                <MudSelect @bind-Value="model.Type" 
                           For="@(() => model.Type)"
                           Label="Account Type" 
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense">
                    @foreach (AccountType type in Enum.GetValues<AccountType>())
                    {
                        <MudSelectItem Value="@type">@type.ToString()</MudSelectItem>
                    }
                </MudSelect>

                <MudNumericField @bind-Value="model.InitialBalance" 
                                 For="@(() => model.InitialBalance)"
                                 Label="Initial Balance"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Format="C"
                                 Culture="@System.Globalization.CultureInfo.CurrentCulture" />

                <MudTextField @bind-Value="model.Currency" 
                              For="@(() => model.Currency)" 
                              Label="Currency"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              MaxLength="3" />

                <MudTextField @bind-Value="model.AccountNumber" 
                              For="@(() => model.AccountNumber)" 
                              Label="Account Number (Optional)"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />

                <MudTextField @bind-Value="model.BankName" 
                              For="@(() => model.BankName)" 
                              Label="Bank Name (Optional)"
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense" />
            </MudCardContent>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" OnClick="Submit" Variant="Variant.Filled">Create Account</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;

    private CreateAccountDto model = new();
    private MudForm form = null!;

    protected override void OnInitialized()
    {
        model.Currency = "USD";
        model.Type = AccountType.Checking;
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Submit()
    {
        await form.Validate();
        
        if (form.IsValid)
        {
            try
            {
                await AccountService.CreateAsync(model);
                MudDialog.Close(DialogResult.Ok(true));
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error creating account: {ex.Message}", MudSeverity.Error);
            }
        }
    }
}